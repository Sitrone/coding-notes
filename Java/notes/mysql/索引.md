###  索引

索引的**目的**：提升query的速度

索引的常见实现：哈希和树

哈希的缺点：无法实现快速的范围查找



#### `B-Tree`和`B+Tree`

大部分数据库系统及文件系统都采用B-Tree或其变种B+Tree作为索引结构

B-Tree：自平衡二叉树，能够让查找数据、顺序访问、插入数据及删除的动作，都在对数时间内完成

B+Tree：自平衡二叉树，B树的变种，与之最大的区别是，内节点不存储data，只存储key 



相关知识点：

1. 主存读取原理 
2. 磁盘读取原理：磁盘寻道
3. 局部性原理：当一个数据被用到时，其附近的数据也通常会马上被使用
4. 磁盘预读：磁盘读写并不是按需读取，而是按页预读，一次会读一页的数据，每次加载更多的数据，如果未来要读取的数据就在这一页中，可以避免未来的磁盘IO，提高效率



使用B-Tree或B+Tree的原因：

1. 索引往往以索引文件的形式存储的磁盘上，IO读取的效率很低
2. B-Tree的高度很低，极大的减少IO读取次数
3. 每个节点可以存储多个记录，如果将节点的大小设置为页大小（4k），能够充分利用预读的特性
4. B+Tree节点中间单向链表连接，加速了范围查找 



### InnoDB与MyISAM索引区别

MyISAM

* 使用B+Tree作为索引结构，叶节点的data域存放的是数据记录的地址，索引与行记录是分开存储的
* 索引方式也叫做“非聚集”的

InnoDB

* **主键索引与**行记录是存储在一起的，故叫做**聚集索引**
* 辅助索引data域存储相应记录主键的值而不是地址



使用启示：

1. 为什么不建议使用过长的字段作为主键，因为所有辅助索引都引用主索引，过长的主索引会令辅助索引变得过大
2. 建议使用趋势递增的key做主键，由于数据行与索引一体，这样不至于插入记录时，有大量索引分裂，行记录移动，**因此如果没有特别的需要，请永远使用一个与业务无关的自增字段作为主键**



### 索引的优化和选择策略 

联合索引的最左前缀原理

1. 范围列可以用到索引（必须是最左前缀）

2. 联合索引匹配最左匹配

3. 如果通配符%不出现在开头，则可以用到索引，但根据具体情况不同可能只会用其中一个前缀

4. 如果查询条件中含有函数或表达式，则MySQL不会为这列使用索引

5. 表记录小于2000条无需建索引

6. 一张表不宜建立太多索引

7. 索引选择的原则，选择选择性高的列作为索引

8. MySQL无法使用前缀索引做order by和group by，也无法使用前缀索引做覆盖扫描


### 查询性能优化

* 复杂查询拆分成多个简单查询
* 大查询分而治之
* 分解关联查询，将结果再应用层面关联
  * 单个查询查询后能够缓存，效率更高
  * 查询分解后，执行单个查询减少锁的竞争
  * 在应用层做关联，更容易对数据库进行拆分，做到高性能和可扩展

### Reference

1. [[MySQL索引背后的数据结构及算法原理](http://blog.codinglabs.org/articles/theory-of-mysql-index.html)]
2. [B-tree](https://en.wikipedia.org/wiki/B-tree)
3. 高性能MySQL 
4. [关于MySQL内核一定要知道的](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961620&idx=1&sn=d858c302799cad451656129885214767&chksm=bd2d0cc88a5a85de11ed376570f78a22954e88aad06f0138b3fbfb7be1968699421ac0b99889&scene=21#wechat_redirect)